#!/bin/sh

echo '################################'
echo '##                           ##'
echo '##   ğŸ–¥ï¸ Setup machine        ##'
echo '##                           ##'
echo '################################'
echo

USER=$(whoami)
PASSWORD=""

read -s -p 'ğŸ”‘ Enter your user password: ' PASSWORD
echo
echo

if ! builtin type -p 'yay' >/dev/null 2>&1; then
  CWD=`pwd`
  echo 'ğŸ¥£ Installing yay..'
  tmpdir="$(command mktemp -d)"
  command cd "${tmpdir}" || return 1
  sudo pacman -Sy --needed --noconfirm base base-devel git >/dev/null 2>&1
  git clone https://aur.archlinux.org/yay-bin.git >/dev/null 2>&1
  cd yay-bin
  makepkg -si <<< 'yes' >/dev/null 2>&1
  cd $CWD
  rm -rf "${tmpdir}"
  echo 'ğŸ‰ yay installed!'
  echo
fi

echo 'ğŸ“¦ Installing base packages...'
yay --noconfirm >/dev/null 2>&1
echo 'ğŸ‰ Base packages installed!'
echo

echo 'ğŸ“¦ Installing own packages...'
curl -Lks https://raw.githubusercontent.com/rabume/arch-post-install/main/packages.csv | tail -n +2 | cut -d, -f1 | yay -Sy --noconfirm - >/dev/null 2>&1
echo 'ğŸ‰ Base packages installed!'
echo

echo 'ğŸ”§ Download and setup dotfiles...'
git clone https://github.com/rabume/dotfiles.git $HOME/dotfiles >/dev/null 2>&1
cd $HOME/dotfiles
stow --adopt . >/dev/null 2>&1
cd $CWD
echo 'ğŸ‰ Dotfiles setup complete!'
echo

echo
echo 'ğŸ  Setup home directory...'
mkdir -p $HOME/Pictures/wallpaper
mkdir -p $HOME/Downloads
mkdir -p $HOME/Development
echo 'ğŸ‰ Home directory setup complete!'
echo

echo 'ğŸ”§ Setup services...'
# Docker
sudo systemctl start docker.service >/dev/null 2>&1
sudo systemctl enable docker.service >/dev/null 2>&1
sudo groupadd docker >/dev/null 2>&1
sudo usermod -aG docker $USER >/dev/null 2>&1
echo 'ğŸ‰ Docker setup complete!'
# Bluetooth
sudo systemctl start bluetooth.service >/dev/null 2>&1
sudo systemctl enable bluetooth.service >/dev/null 2>&1
echo 'ğŸ‰ Bluetooth setup complete!'
# Cups
sudo systemctl start cups >/dev/null 2>&1
sudo systemctl enable cups >/dev/null 2>&1
echo 'ğŸ‰ Cups setup complete!'
# SSH
sudo systemctl start sshd >/dev/null 2>&1
sudo systemctl enable sshd >/dev/null 2>&1
echo 'ğŸ‰ SSH setup complete!'
echo

echo 'ğŸ”§ Set up theme...'
gsettings set org.gnome.desktop.interface color-scheme prefer-dark >/dev/null 2>&1
gsettings set org.gnome.desktop.interface gtk-theme Catppucin-Mocha-Standard-Lavender-Dark >/dev/null 2>&1

# create syslinks for theme
ln -sf "/usr/share/themes/Catppuccin-Mocha-Standard-Lavender-Dark/gtk-4.0/gtk-dark.css" "/home/$USER/.config/gtk-4.0/gtk-dark.css" >/dev/null 2>&1
ln -sf "/usr/share/themes/Catppuccin-Mocha-Standard-Lavender-Dark/gtk-4.0/gtk.css" "/home/$USER/.config/gtk-4.0/gtk.css" >/dev/null 2>&1
ln -sf "/usr/share/themes/Catppuccin-Mocha-Standard-Lavender-Dark/gtk-4.0/assets" "/home/$USER/.config/gtk-4.0/assets" >/dev/null 2>&1

echo 'ğŸ‰ Theme setup complete!'
echo

echo 'ğŸ”§ Setup development tools...'

curl -sSL https://git.io/g-install | sh -s -- bash fish -y >/dev/null 2>&1
echo 'ğŸ‰ Go setup complete!'

# git profile
go get -u github.com/dotzero/git-profile >/dev/null 2>&1
echo 'ğŸ‰ Git profile setup complete!'
echo

echo 'ğŸš Shell setup...'
chsh -s /bin/fish <<< $PASSWORD >/dev/null 2>&1
fish && curl -sL https://raw.githubusercontent.com/jorgebucaran/fisher/main/functions/fisher.fish | source && fisher install jorgebucaran/fisher >/dev/null 2>&1
fish && fisher install FabioAntunes/fish-nvm edc/bass >/dev/null 2>&1
echo 'ğŸ‰ shell setup complete!'
echo

echo 'ğŸ§¹ Clear pacman and yay cache'
yay -Sc --noconfirm - 2>/dev/null
rm -rf ~/.cache/yay/* - 2>/dev/null
rm -rf ~/.cache/go-build/* - 2>/dev/null
sudo rm -rf /var/cache/pacman/pkg/* - 2>/dev/null
echo 'ğŸ‰ Cache cleared!'
echo

echo
echo '###################################################'
echo '##                                               ##'
echo '##          ğŸ‘ Installation Complete             ##'
echo '##      reboot to use the new configurations     ##'
echo '##                                               ##'
echo '###################################################'
echo